<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - DK Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tab-container {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            background: transparent;
            border: none;
            font-size: 1rem;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: #4CAF50;
            color: white;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Order Creation Styles */
        .order-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            background: #f8f9fa;
        }

        .form-section h3 {
            color: #4CAF50;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: #4CAF50;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        /* Cart Items Styles */
        .cart-items {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 60px 1fr 80px 80px 100px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            gap: 15px;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item:nth-child(even) {
            background: #f8f9fa;
        }

        .item-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #ddd;
        }

        .item-name {
            font-weight: 600;
            color: #333;
        }

        .item-price {
            color: #4CAF50;
            font-weight: 600;
        }

        .total-section {
            background: #4CAF50;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Order Management Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .orders-grid {
            display: grid;
            gap: 20px;
        }

        .order-card {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .order-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .order-id {
            font-weight: bold;
            color: #4CAF50;
            font-size: 1.1rem;
        }

        .order-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-ready { background: #d4edda; color: #155724; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detail-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
        }

        .detail-value {
            color: #333;
            font-weight: 500;
        }

        .order-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ddd;
        }

        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-control {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            min-width: 150px;
        }

        @media (max-width: 768px) {
            .tab-container {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .order-details {
                grid-template-columns: 1fr;
            }

            .cart-item {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1><i class="fas fa-shopping-cart"></i> Order Management System</h1>
        <p>Complete order processing and management solution</p>
    </div>

    <div class="tab-container">
        <button class="tab active" onclick="switchTab('create-order')">
            <i class="fas fa-plus-circle"></i> Create Order
        </button>
        <button class="tab" onclick="switchTab('manage-orders')">
            <i class="fas fa-list-alt"></i> Manage Orders
        </button>
        <button class="tab" onclick="switchTab('order-queue')">
            <i class="fas fa-clock"></i> Order Queue
        </button>
        <button class="tab" onclick="switchTab('completed-orders')">
            <i class="fas fa-check-circle"></i> Completed Orders
        </button>
    </div>

    <div class="content">
        <!-- Create Order Tab -->
        <div id="create-order" class="tab-content active">
            <div class="order-form">
                <div class="form-section">
                    <h3><i class="fas fa-shopping-bag"></i> Order Type</h3>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="pickup" name="orderType" value="pickup" checked onchange="toggleOrderType()">
                            <label for="pickup">Pickup Order</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="delivery" name="orderType" value="delivery" onchange="toggleOrderType()">
                            <label for="delivery">Delivery Order</label>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-shopping-cart"></i> Cart Items</h3>
                    <div id="cart-items-container" class="cart-items">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Loading cart items...</p>
                        </div>
                    </div>
                </div>

                <div id="pickup-details" class="form-section">
                    <h3><i class="fas fa-map-marker-alt"></i> Pickup Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">Customer Name</label>
                            <input type="text" id="customerName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">Phone Number</label>
                            <input type="tel" id="phoneNumber" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="pickupLocation">Pickup Location</label>
                        <select id="pickupLocation" class="form-control" required>
                            <option value="">Select pickup location</option>
                            <option value="Main Store - Colombo">Main Store - Colombo</option>
                            <option value="Branch Store - Kandy">Branch Store - Kandy</option>
                            <option value="Branch Store - Galle">Branch Store - Galle</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="preferredPickupTime">Preferred Pickup Time</label>
                        <input type="datetime-local" id="preferredPickupTime" class="form-control">
                    </div>
                </div>

                <div id="delivery-details" class="form-section hidden">
                    <h3><i class="fas fa-truck"></i> Delivery Details</h3>
                    <div class="form-group">
                        <label for="deliveryAddress">Delivery Address</label>
                        <textarea id="deliveryAddress" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="postalCode">Postal Code</label>
                            <input type="text" id="postalCode" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="deliveryInstructions">Delivery Instructions (Optional)</label>
                        <textarea id="deliveryInstructions" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deliveryFee">Delivery Fee (Rs.)</label>
                            <input type="number" id="deliveryFee" class="form-control" value="200" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Payment Method</label>
                            <select id="paymentMethod" class="form-control" required>
                                <option value="">Select payment method</option>
                                <option value="CREDIT_CARD">Credit Card</option>
                                <option value="DEBIT_CARD">Debit Card</option>
                                <option value="PAYPAL">PayPal</option>
                                <option value="COD">Cash on Delivery</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="createOrder()">
                        <i class="fas fa-check"></i> Create Order
                    </button>
                </div>
            </div>
        </div>

        <!-- Manage Orders Tab -->
        <div id="manage-orders" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-orders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-orders">0</div>
                    <div class="stat-label">Pending Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="processing-orders">0</div>
                    <div class="stat-label">Processing Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completed-orders-count">0</div>
                    <div class="stat-label">Completed Orders</div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-group">
                    <label>Filter by Status</label>
                    <select id="status-filter" class="filter-control" onchange="filterOrders()">
                        <option value="">All Statuses</option>
                        <option value="PENDING">Pending</option>
                        <option value="PROCESSING">Processing</option>
                        <option value="READY">Ready</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="CANCELLED">Cancelled</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Filter by Type</label>
                    <select id="type-filter" class="filter-control" onchange="filterOrders()">
                        <option value="">All Types</option>
                        <option value="PICKUP">Pickup</option>
                        <option value="ONLINE">Delivery</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Search by Order ID</label>
                    <input type="text" id="search-filter" class="filter-control" placeholder="Enter Order ID" onkeyup="filterOrders()">
                </div>
            </div>

            <div id="orders-container" class="orders-grid">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading orders...</p>
                </div>
            </div>
        </div>

        <!-- Order Queue Tab -->
        <div id="order-queue" class="tab-content">
            <div style="display: flex; gap: 15px; margin-bottom: 25px; justify-content: center;">
                <button class="btn" onclick="processNextOrder()">
                    <i class="fas fa-play"></i> Process Next Order
                </button>
                <button class="btn btn-secondary" onclick="processAllOrders()">
                    <i class="fas fa-fast-forward"></i> Process All Orders
                </button>
                <button class="btn btn-secondary" onclick="getQueueStatistics()">
                    <i class="fas fa-chart-bar"></i> Queue Statistics
                </button>
            </div>

            <div id="queue-container" class="orders-grid">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading queue...</p>
                </div>
            </div>
        </div>

        <!-- Completed Orders Tab -->
        <div id="completed-orders" class="tab-content">
            <div id="completed-container" class="orders-grid">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading completed orders...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let currentUser = null;
    let cartItems = [];
    let allItems = [];
    let allOrders = [];

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is logged in
        currentUser = JSON.parse(localStorage.getItem('user'));
        if (!currentUser) {
            alert('Please log in to access the order management system.');
            window.location.href = 'login.html';
            return;
        }

        // Load initial data
        loadCartItems();
        loadAllItems();
        loadOrders();
    });

    // Tab switching functionality
    function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Show selected tab content
        document.getElementById(tabName).classList.add('active');

        // Add active class to clicked tab
        event.target.classList.add('active');

        // Load data based on tab
        switch(tabName) {
            case 'create-order':
                loadCartItems();
                break;
            case 'manage-orders':
                loadOrders();
                break;
            case 'order-queue':
                loadQueueOrders();
                break;
            case 'completed-orders':
                loadCompletedOrders();
                break;
        }
    }

    // Toggle order type (pickup/delivery)
    function toggleOrderType() {
        const orderType = document.querySelector('input[name="orderType"]:checked').value;
        const pickupDetails = document.getElementById('pickup-details');
        const deliveryDetails = document.getElementById('delivery-details');

        if (orderType === 'pickup') {
            pickupDetails.classList.remove('hidden');
            deliveryDetails.classList.add('hidden');
        } else {
            pickupDetails.classList.add('hidden');
            deliveryDetails.classList.remove('hidden');
        }
    }

    // Load cart items
    async function loadCartItems() {
        try {
            const response = await fetch(`http://localhost:8080/api/cart/user/${currentUser.id}`);
            cartItems = await response.json();
            displayCartItems();
        } catch (error) {
            console.error('Error loading cart items:', error);
            document.getElementById('cart-items-container').innerHTML =
                '<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>No items in cart</p></div>';
        }
    }

    // Load all items for reference
    async function loadAllItems() {
        try {
            const response = await fetch('http://localhost:8080/api/items');
            allItems = await response.json();
        } catch (error) {
            console.error('Error loading items:', error);
        }
    }

    // Display cart items
    function displayCartItems() {
        const container = document.getElementById('cart-items-container');

        if (cartItems.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>No items in cart</p></div>';
            return;
        }

        let totalAmount = 0;
        let html = '';

        cartItems.forEach(cartItem => {
            const item = allItems.find(i => i.id === cartItem.itemId);
            if (item) {
                const itemTotal = item.price * cartItem.quantity;
                totalAmount += itemTotal;

                html += `
                        <div class="cart-item">
                            <img src="${item.imagePath || 'images/placeholder.png'}" alt="${item.name}" class="item-image">
                            <div class="item-name">${item.name}</div>
                            <div class="item-price">Rs. ${item.price.toFixed(2)}</div>
                            <div>Qty: ${cartItem.quantity}</div>
                            <div class="item-price">Rs. ${itemTotal.toFixed(2)}</div>
                        </div>
                    `;
            }
        });

        html += `<div class="total-section">Total: Rs. ${totalAmount.toFixed(2)}</div>`;
        container.innerHTML = html;
    }

    // Create order
    async function createOrder() {
        if (cartItems.length === 0) {
            alert('Your cart is empty. Please add items to cart before creating an order.');
            return;
        }

        const orderType = document.querySelector('input[name="orderType"]:checked').value;
        let orderData;

        try {
            if (orderType === 'pickup') {
                orderData = {
                    userId: currentUser.id,
                    customerName: document.getElementById('customerName').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    pickupLocation: document.getElementById('pickupLocation').value,
                    preferredPickupTime: document.getElementById('preferredPickupTime').value || null
                };

                if (!orderData.customerName || !orderData.phoneNumber || !orderData.pickupLocation) {
                    alert('Please fill in all required pickup details.');
                    return;
                }

                // Format the preferred pickup time if provided
                if (orderData.preferredPickupTime) {
                    orderData.preferredPickupTime = orderData.preferredPickupTime.replace('T', ' ') + ':00';
                }

                const response = await fetch('http://localhost:8080/api/orders/pickup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    const order = await response.json();
                    alert(`Pickup order created successfully! Order ID: ${order.id}`);
                    // Clear form and reload cart
                    document.querySelector('form').reset() || clearForm();
                    loadCartItems();
                    switchTab('manage-orders');
                } else {
                    const error = await response.text();
                    alert('Error creating pickup order: ' + error);
                }

            } else {
                orderData = {
                    userId: currentUser.id,
                    deliveryAddress: document.getElementById('deliveryAddress').value,
                    city: document.getElementById('city').value,
                    postalCode: document.getElementById('postalCode').value,
                    deliveryInstructions: document.getElementById('deliveryInstructions').value || '',
                    deliveryFee: parseFloat(document.getElementById('deliveryFee').value) || 200,
                    paymentMethod: document.getElementById('paymentMethod').value
                };

                if (!orderData.deliveryAddress || !orderData.city || !orderData.postalCode || !orderData.paymentMethod) {
                    alert('Please fill in all required delivery details.');
                    return;
                }

                const response = await fetch('http://localhost:8080/api/orders/online', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    const order = await response.json();
                    alert(`Delivery order created successfully! Order ID: ${order.id}`);
                    // Clear form and reload cart
                    clearForm();
                    loadCartItems();
                    switchTab('manage-orders');
                } else {
                    const error = await response.text();
                    alert('Error creating delivery order: ' + error);
                }
            }
        } catch (error) {
            console.error('Error creating order:', error);
            alert('Error creating order. Please try again.');
        }
    }

    // Clear form fields
    function clearForm() {
        document.getElementById('customerName').value = '';
        document.getElementById('phoneNumber').value = '';
        document.getElementById('pickupLocation').value = '';
        document.getElementById('preferredPickupTime').value = '';
        document.getElementById('deliveryAddress').value = '';
        document.getElementById('city').value = '';
        document.getElementById('postalCode').value = '';
        document.getElementById('deliveryInstructions').value = '';
        document.getElementById('deliveryFee').value = '200';
        document.getElementById('paymentMethod').value = '';
    }

    // Load all orders
    async function loadOrders() {
        try {
            const response = await fetch('http://localhost:8080/api/orders');
            allOrders = await response.json();
            updateOrderStats();
            displayOrders(allOrders);
        } catch (error) {
            console.error('Error loading orders:', error);
            document.getElementById('orders-container').innerHTML =
                '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading orders</p></div>';
        }
    }

    // Update order statistics
    function updateOrderStats() {
        const total = allOrders.length;
        const pending = allOrders.filter(o => o.status === 'PENDING').length;
        const processing = allOrders.filter(o => o.status === 'PROCESSING').length;
        const completed = allOrders.filter(o => o.status === 'COMPLETED').length;

        document.getElementById('total-orders').textContent = total;
        document.getElementById('pending-orders').textContent = pending;
        document.getElementById('processing-orders').textContent = processing;
        document.getElementById('completed-orders-count').textContent = completed;
    }

    // Display orders
    function displayOrders(orders) {
        const container = document.getElementById('orders-container');

        if (orders.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No orders found</p></div>';
            return;
        }

        let html = '';
        orders.forEach(order => {
            html += createOrderCard(order);
        });

        container.innerHTML = html;
    }

    // Create order card HTML
    function createOrderCard(order) {
        const orderTypeIcon = order.orderType === 'PICKUP' ? 'fas fa-map-marker-alt' : 'fas fa-truck';
        const statusClass = `status-${order.status.toLowerCase()}`;

        return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-id">
                            <i class="${orderTypeIcon}"></i> ${order.id}
                        </div>
                        <div class="order-status ${statusClass}">${order.status}</div>
                    </div>

                    <div class="order-details">
                        <div class="detail-group">
                            <div class="detail-label">Order Type</div>
                            <div class="detail-value">${order.orderType}</div>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Total Amount</div>
                            <div class="detail-value">Rs. ${order.totalAmount.toFixed(2)}</div>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Order Time</div>
                            <div class="detail-value">${formatDateTime(order.orderTime)}</div>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Estimated Time</div>
                            <div class="detail-value">${order.estimatedTime ? formatDateTime(order.estimatedTime) : 'Not set'}</div>
                        </div>
                        ${order.orderType === 'PICKUP' ? `
                            <div class="detail-group">
                                <div class="detail-label">Customer</div>
                                <div class="detail-value">${order.customerName}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Phone</div>
                                <div class="detail-value">${order.phoneNumber}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Pickup Location</div>
                                <div class="detail-value">${order.pickupLocation}</div>
                            </div>
                        ` : `
                            <div class="detail-group">
                                <div class="detail-label">Delivery Address</div>
                                <div class="detail-value">${order.deliveryAddress}, ${order.city} ${order.postalCode}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Payment Method</div>
                                <div class="detail-value">${order.paymentMethod}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Payment Status</div>
                                <div class="detail-value">${order.paymentStatus || 'Pending'}</div>
                            </div>
                        `}
                    </div>

                    <div class="order-actions">
                        ${getOrderActions(order)}
                    </div>
                </div>
            `;
    }

    // Get available actions for order based on status and type
    function getOrderActions(order) {
        let actions = '';

        switch(order.status) {
            case 'PENDING':
                actions += `<button class="btn btn-sm" onclick="processOrder('${order.id}')"><i class="fas fa-play"></i> Process</button>`;
                actions += `<button class="btn btn-sm btn-danger" onclick="cancelOrder('${order.id}')"><i class="fas fa-times"></i> Cancel</button>`;
                break;

            case 'PROCESSING':
                if (order.orderType === 'PICKUP') {
                    actions += `<button class="btn btn-sm" onclick="markPickupReady('${order.id}')"><i class="fas fa-check"></i> Mark Ready</button>`;
                } else {
                    actions += `<button class="btn btn-sm" onclick="markOutForDelivery('${order.id}')"><i class="fas fa-truck"></i> Out for Delivery</button>`;
                    actions += `<button class="btn btn-sm btn-secondary" onclick="updatePaymentStatus('${order.id}')"><i class="fas fa-credit-card"></i> Update Payment</button>`;
                }
                actions += `<button class="btn btn-sm btn-danger" onclick="cancelOrder('${order.id}')"><i class="fas fa-times"></i> Cancel</button>`;
                break;

            case 'READY':
                if (order.orderType === 'PICKUP') {
                    actions += `<button class="btn btn-sm" onclick="confirmPickup('${order.id}')"><i class="fas fa-handshake"></i> Confirm Pickup</button>`;
                }
                break;

            case 'OUT_FOR_DELIVERY':
                actions += `<button class="btn btn-sm" onclick="confirmDelivery('${order.id}')"><i class="fas fa-check-circle"></i> Confirm Delivery</button>`;
                break;
        }

        actions += `<button class="btn btn-sm btn-secondary" onclick="getOrderPosition('${order.id}')"><i class="fas fa-info"></i> Queue Position</button>`;

        return actions;
    }

    // Filter orders
    function filterOrders() {
        const statusFilter = document.getElementById('status-filter').value;
        const typeFilter = document.getElementById('type-filter').value;
        const searchFilter = document.getElementById('search-filter').value.toLowerCase();

        let filteredOrders = allOrders;

        if (statusFilter) {
            filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
        }

        if (typeFilter) {
            filteredOrders = filteredOrders.filter(order => order.orderType === typeFilter);
        }

        if (searchFilter) {
            filteredOrders = filteredOrders.filter(order =>
                order.id.toLowerCase().includes(searchFilter)
            );
        }

        displayOrders(filteredOrders);
    }

    // Load queue orders
    async function loadQueueOrders() {
        try {
            const response = await fetch('http://localhost:8080/api/orders/queue');
            const queueOrders = await response.json();
            displayQueueOrders(queueOrders);
        } catch (error) {
            console.error('Error loading queue orders:', error);
            document.getElementById('queue-container').innerHTML =
                '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading queue</p></div>';
        }
    }

    // Display queue orders
    function displayQueueOrders(orders) {
        const container = document.getElementById('queue-container');

        if (orders.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-clock"></i><p>No orders in queue</p></div>';
            return;
        }

        let html = '';
        orders.forEach((order, index) => {
            html += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">
                                <span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 15px; font-size: 0.8rem; margin-right: 10px;">
                                    #${index + 1}
                                </span>
                                <i class="${order.orderType === 'PICKUP' ? 'fas fa-map-marker-alt' : 'fas fa-truck'}"></i> ${order.id}
                            </div>
                            <div class="order-status status-${order.status.toLowerCase()}">${order.status}</div>
                        </div>
                        <div class="order-details">
                            <div class="detail-group">
                                <div class="detail-label">Order Type</div>
                                <div class="detail-value">${order.orderType}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Total Amount</div>
                                <div class="detail-value">Rs. ${order.totalAmount.toFixed(2)}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Queue Position</div>
                                <div class="detail-value">#${index + 1}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Estimated Wait</div>
                                <div class="detail-value">${(index * 15)} minutes</div>
                            </div>
                        </div>
                    </div>
                `;
        });

        container.innerHTML = html;
    }

    // Load completed orders
    async function loadCompletedOrders() {
        try {
            const response = await fetch('http://localhost:8080/api/orders/completed');
            const completedOrders = await response.json();
            displayCompletedOrders(completedOrders);
        } catch (error) {
            console.error('Error loading completed orders:', error);
            document.getElementById('completed-container').innerHTML =
                '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading completed orders</p></div>';
        }
    }

    // Display completed orders
    function displayCompletedOrders(orders) {
        const container = document.getElementById('completed-container');

        if (orders.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>No completed orders</p></div>';
            return;
        }

        let html = '';
        orders.forEach(order => {
            html += createOrderCard(order);
        });

        container.innerHTML = html;
    }

    // Order management functions
    async function processOrder(orderId) {
        try {
            const response = await fetch('http://localhost:8080/api/orders/process-next', {
                method: 'POST'
            });

            if (response.ok) {
                alert('Order processed successfully!');
                loadOrders();
                loadQueueOrders();
            } else {
                const error = await response.text();
                alert('Error processing order: ' + error);
            }
        } catch (error) {
            console.error('Error processing order:', error);
            alert('Error processing order. Please try again.');
        }
    }

    async function processNextOrder() {
        try {
            const response = await fetch('http://localhost:8080/api/orders/process-next', {
                method: 'POST'
            });

            if (response.ok) {
                const result = await response.text();
                alert('Next order processed: ' + result);
                loadOrders();
                loadQueueOrders();
            } else {
                const error = await response.text();
                alert('Error: ' + error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error processing next order.');
        }
    }

    async function processAllOrders() {
        if (!confirm('Are you sure you want to process all orders in the queue?')) {
            return;
        }

        try {
            const response = await fetch('http://localhost:8080/api/orders/process-all', {
                method: 'POST'
            });

            if (response.ok) {
                alert('All orders processed successfully!');
                loadOrders();
                loadQueueOrders();
            } else {
                const error = await response.text();
                alert('Error: ' + error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error processing all orders.');
        }
    }

    async function cancelOrder(orderId) {
        if (!confirm('Are you sure you want to cancel this order?')) {
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/orders/${orderId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Order cancelled successfully!');
                loadOrders();
                loadQueueOrders();
            } else {
                const error = await response.text();
                alert('Error cancelling order: ' + error);
            }
        } catch (error) {
            console.error('Error cancelling order:', error);
            alert('Error cancelling order. Please try again.');
        }
    }

    async function markPickupReady(orderId) {
        try {
            const response = await fetch(`http://localhost:8080/api/orders/pickup/${orderId}/ready`, {
                method: 'PUT'
            });

            if (response.ok) {
                alert('Order marked as ready for pickup!');
                loadOrders();
            } else {
                const error = await response.text();
                alert('Error: ' + error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error marking order ready.');
        }
    }

    async function confirmPickup(orderId) {
        if (!confirm('Confirm that this order has been picked up?')) {
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/orders/pickup/${orderId}/confirm`, {
                method: 'PUT'
            });

            if (response.ok) {
                alert('Pickup confirmed successfully!');
                loadOrders();
                loadCompletedOrders();
            } else {
                const error = await response.text();
                alert('Error: ' + error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error confirming pickup.');
        }
    }

    async function markOutForDelivery(orderId) {
        try {
            const response = await fetch(`http://localhost:8080/api/orders/online/${orderId}/delivery`, {
                method: 'PUT'
            });

            if (response.ok) {
                alert('Order marked as out for delivery!');
                loadOrders();
            } else {
                const error = await response.text();
                alert('Error: ' + error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error marking out for delivery.');
        }
    }

    async function confirmDelivery(orderId) {
        if (!confirm('Confirm that this order has been delivered?')) {
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/orders/online/${orderId}/confirm-delivery`, {
                method: 'PUT'
            });

            if (response.ok) {
                alert('Delivery confirmed successfully!');
                loadOrders();
                loadCompletedOrders();
            } else {
                const error = await response.text();
                alert('Error: ' + error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error confirming delivery.');
        }
    }

    async function updatePaymentStatus(orderId) {
        const paymentStatus = prompt('Enter payment status (PENDING, PAID, FAILED, REFUNDED):', 'PAID');
        if (!paymentStatus) return;

        try {
            const response = await fetch(`http://localhost:8080/api/orders/${orderId}/payment`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentStatus: paymentStatus.toUpperCase() })
            });

            if (response.ok) {
                alert('Payment status updated successfully!');
                loadOrders();
            } else {
                const error = await response.text();
                alert('Error: ' + error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error updating payment status.');
        }
    }

    async function getOrderPosition(orderId) {
        try {
            const response = await fetch(`http://localhost:8080/api/orders/${orderId}/position`);

            if (response.ok) {
                const result = await response.json();
                alert(`Order ${orderId} is at position #${result.position} in the queue.`);
            } else {
                const error = await response.text();
                alert('Error: ' + error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error getting order position.');
        }
    }

    async function getQueueStatistics() {
        try {
            const response = await fetch('http://localhost:8080/api/orders/queue/statistics');

            if (response.ok) {
                const statistics = await response.text();
                alert(statistics);
            } else {
                const error = await response.text();
                alert('Error: ' + error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error getting queue statistics.');
        }
    }

    // Utility functions
    function formatDateTime(dateTimeString) {
        const date = new Date(dateTimeString);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Auto-refresh functionality
    setInterval(() => {
        const activeTab = document.querySelector('.tab-content.active').id;
        if (activeTab === 'manage-orders') {
            loadOrders();
        } else if (activeTab === 'order-queue') {
            loadQueueOrders();
        } else if (activeTab === 'completed-orders') {
            loadCompletedOrders();
        }
    }, 30000); // Refresh every 30 seconds
</script>
</body>
</html>